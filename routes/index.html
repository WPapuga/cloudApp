<!DOCTYPE html>
 
<html>
    <head>
        <title>CloudApp</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="style.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
          .Navbar {
            background-color: lightblue;
            border-bottom-color: lightblue;
            width: 100%;
            height: 80px;
            font-family: Arial, Helvetica, sans-serif;
            display: flex;
          }

          .Navbar a {
            text-decoration: none;
          }

          .Navbar .NavLeftSide {
            flex: 20%;
            display: flex;
            max-height: 80px;
            align-items: center;
            color: black;
          }
          .Navbar .NavLeftSide a {
            font-size: 30px;
            margin-left: 5px;
            font-weight: bold;
          }

          .Navbar .NavLinks {
            flex: 55%;
            max-height: 80px;
            display: flex;
            justify-content: left;
            align-items: center;
          }
          .Navbar .NavLinks a {
            text-decoration: none;
            color: black;
            font-size: 23px;
            margin-left: 35px;
          }

          .Navbar .NavSigning {
            display: flex;
            align-items: center;
            margin-right: 3%;
          }
          .Navbar .NavSigning a {
            text-decoration: none;
            color: black;
            font-size: 23px;
            margin-left: 15px;
          }
          .Navbar .NavSigning .SignUpButton {
            margin-left: 30px;
            margin-right: 40px;
            font-size: 23px;
            background-color: white;
            border-color: #2F327D;
            color: #2F327D;
          }
          .Navbar .NavSigning .SignUpButton:hover {
            margin-left: 30px;
            margin-right: 40px;
            font-size: 23px;
            background-color: #30CB70;
            border-color: #30CB70;
            color: white;
          }

          .Navbar .active a {
            color: #30CB70;
          }

          .Navbar a:hover {
            color: #30CB70;
          }

          .Navbar .active .SignUpButton {
            background-color: #30CB70;
            border-color: #30CB70;
            color: white;
          } 

          table {
            border-collapse: collapse;
            width: 100%;
          }

          th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
          }

          th {
            background-color: #f2f2f2;
            color: #333;
          } 

          .tableDropdownButton {
            background-color: #04AA6D;
            color: white;
            padding: 16px;
            font-size: 16px;
            border: none;
          }

          .tableDropdown {
            position: relative;
            display: inline-block;
          }

          .tableDropdownContent {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
          }

          .tableDropdownContent a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
          }

          .tableDropdownContent a:hover {background-color: #ddd;}

          .tableDropdown:hover .tableDropdownContent {display: block;}

          .tableDropdown:hover .tableDropdownButton {background-color: #3e8e41;}
        </style>
    </head>
    <body onload="loadPage()">
        <div class="Navbar">
            <div class="NavLeftSide">
                <a>DB browser</a>
            </div>
            <div class="NavLinks">
                <a onclick="window.location.href = '/';">Strona Główna</a>
                <a id="dbName"></a>
                <div class="tableDropdown">
                  <input class="tableDropdownButton" type="button" value="Wybierz tabelę"  id="drpbtn" />
                  <div class="tableDropdownContent">

                  </div>
                </div>
                <button onclick="getTableData()">pokaż zawartość tabeli</button>
            </div>
            <div class="NavSigning">
                <p id="usernameP"></p>
                <a id="loginButton" onclick="window.location.href = '/login';">Zaloguj się przez Google!</a>
                <a id="loginGhButton" onclick="window.location.href = '/loginGH';">Zaloguj się przez GitHub!</a>
                <a id="logout" onclick="window.location.href = '/logout';">Wyloguj się</a>
            </div>
        </div>
        <div>
            <table id="dataTable">
              <tr>
                <th>name</th>
                <th>joined date</th>
                <th>last visit</th>
                <th>counter</th>
              </tr>
            </table>
        </div>
        <script type="text/javascript">
          sessionStorage.setItem('isLogged', 'false');
          sessionStorage.setItem('selectedTable', '');
          const dataTable = document.getElementById('dataTable');

          function loadPage() {
            if (sessionStorage.getItem('isLogged') == 'true') {
            document.getElementById('loginButton').style.display = 'none';
            document.getElementById('loginGhButton').style.display = 'none';
            document.getElementById('logout').style.display = 'block';
            document.getElementById('usernameP').innerHTML = 'Zalogowany jako: ' + sessionStorage.getItem('username');
            } else {
              document.getElementById('loginButton').style.display = 'block';
              document.getElementById('loginGhButton').style.display = 'block';
              document.getElementById('logout').style.display = 'none';
              document.getElementById('usernameP').innerHTML = ' ';
            }
            $.ajax({
              url: '/api/getDBName',
              type: 'GET',
              dataType: 'json',
              success: function(data) {
                document.getElementById('dbName').innerHTML = data.dbname;
              },
              error: function(data) {
                alert("error");
              }
            });
            $.ajax({
              url: '/api/getTables',
              type: 'GET',
              dataType: 'json',
              success: function(data) {
                for (var i = 0; i < data.length; i++) {
                  var a = document.createElement('a');
                  a.innerHTML = data[i].table_name;
                  a.setAttribute("onclick","changeTable(this);");
                  document.getElementsByClassName('tableDropdownContent')[0].appendChild(a);
                }
                console.log(data)
              },
              error: function(data) {
                alert("error");
              }
            });
          
          }

          function changeTable(a) {
            var name = a.innerHTML;
            document.getElementById("drpbtn").value = name;
            sessionStorage.setItem('selectedTable', name)
          }

          function getData() {
            $.ajax({
              url: '/api/getData',
              type: 'GET',
              dataType: 'json',
              success: function(data) {
                data.forEach(function(item) {
                  createRow(item.name, item.joined, item.lastvisit, item.counter);
                  alert(item.data);
                });
              },
              error: function(data) {
                alert("error");
              }
            });
          }

          function getTableData() {
            if(sessionStorage.getItem('selectedTable') == '') {
              alert('Wybierz tabelę!');
              return;
            } else {
              $("#dataTable tr").remove();
              var tableName = sessionStorage.getItem('selectedTable');
              $.ajax({
                url: `/api/getColumns?table=${tableName}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                  var header = dataTable.createTHead();
                  console.log(data[0].column_name);
                  var row = header.insertRow(0);
                  for(var i = 0; i < data.length; i++) {
                    row.insertCell(i).innerHTML = data[i].column_name;
                  }
                  $.ajax({
                    url: `/api/getTableData?table=${tableName}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(tableData) {
                      console.log(tableData);
                      for(var i = 0; i < tableData.length; i++) {
                        var row = dataTable.insertRow();
                        var j = 0;
                        for(value in tableData[i]) {
                          row.insertCell(j).innerHTML =  tableData[i][value];
                          j++;
                        }
                      }
                    },
                    error: function(tableData) {
                      alert("error");
                    }
                  });
                },
                error: function(data) {
                  alert("error");
                }
              });
            }
          }

          function createRow(name, joinedDate, lastVisit, counter) {
            const table = document.getElementById('dataTable');
            var row = table.insertRow();
            row.insertCell(0).innerHTML = name;
            row.insertCell(1).innerHTML = joinedDate;
            row.insertCell(2).innerHTML = lastVisit;
            row.insertCell(3).innerHTML = counter;
          }

        </script>
    </body>
</html>